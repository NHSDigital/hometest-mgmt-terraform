---
name: "Build stage"

on:
  workflow_call:
    inputs:
      build_datetime:
        description: "Build datetime, set by the CI/CD pipeline workflow"
        required: true
        type: string
      build_timestamp:
        description: "Build timestamp, set by the CI/CD pipeline workflow"
        required: true
        type: string
      build_epoch:
        description: "Build epoch, set by the CI/CD pipeline workflow"
        required: true
        type: string
      nodejs_version:
        description: "Node.js version, set by the CI/CD pipeline workflow"
        required: true
        type: string
      python_version:
        description: "Python version, set by the CI/CD pipeline workflow"
        required: true
        type: string
      terraform_version:
        description: "Terraform version, set by the CI/CD pipeline workflow"
        required: true
        type: string
      version:
        description: "Version of the software, set by the CI/CD pipeline workflow"
        required: true
        type: string
      service_ref:
        description: "Git ref for hometest-service repository"
        required: false
        type: string
        default: "main"
    outputs:
      artifact_name:
        description: "Name of the built Lambda artifact"
        value: ${{ jobs.build-lambda.outputs.artifact_name }}
      artifact_hash:
        description: "SHA256 hash of the artifact for Terraform"
        value: ${{ jobs.build-lambda.outputs.source_code_hash }}
      s3_key:
        description: "S3 key for the artifact"
        value: ${{ jobs.build-lambda.outputs.s3_key }}
    secrets:
      SERVICE_REPO_TOKEN:
        description: "GitHub token to access hometest-service repository"
        required: true

jobs:
  build-lambda:
    name: "Build Lambda from hometest-service"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      artifact_name: ${{ steps.build.outputs.artifact_name }}
      source_code_hash: ${{ steps.build.outputs.source_code_hash }}
      s3_key: ${{ steps.build.outputs.s3_key }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Build Lambda"
        id: build
        uses: ./.github/actions/build-lambda
        with:
          service_ref: ${{ inputs.service_ref }}
          node_version: ${{ inputs.nodejs_version }}
          artifact_prefix: "lambda-api-${{ inputs.version }}"
          service_repo_token: ${{ secrets.SERVICE_REPO_TOKEN }}

      - name: "Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_path }}
          retention-days: 30

  security-scan:
    name: "Security scan"
    runs-on: ubuntu-latest
    needs: [build-lambda]
    timeout-minutes: 10
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Download artifact"
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-lambda.outputs.artifact_name }}
          path: artifacts

      - name: "Run Trivy vulnerability scan"
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "artifacts/"
          format: "table"
          exit-code: "0"  # Don't fail on vulnerabilities for now
          severity: "CRITICAL,HIGH"
