---
name: "Deploy Terraform Module"
run-name: "Deploy env: ${{ inputs.environment }}, module: ${{ inputs.module }}, tf: ${{ inputs.action }}"

on:
  workflow_dispatch:
    inputs:
      hometest_service_ref:
        description: "Branch, tag, or SHA to checkout for hometest-service"
        required: false
        default: "main"
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - poc
        default: poc
      stack:
        description: "Infrastructure stack"
        required: true
        type: choice
        options:
          - dev
          - core
        default: dev
      module:
        description: "Terraform module to deploy"
        required: true
        type: choice
        options:
          - hometest-app
          - bootstrap
          - network
          - aurora-postgres
          - shared_services
          - all
        default: hometest-app
      action:
        description: "Terraform action to perform"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy-plan
          - destroy
        default: plan

env:
  AWS_REGION: "eu-west-2"
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  validate-inputs:
    name: "Validate inputs"
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      modules: ${{ steps.set-modules.outputs.modules }}
      working_dir_base: ${{ steps.set-modules.outputs.working_dir_base }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          path: hometest-mgmt-terraform

      - name: "Checkout hometest-service"
        uses: actions/checkout@v6
        with:
          repository: "NHSDigital/hometest-service"
          ref: ${{ inputs.hometest_service_ref }}
          path: hometest-service
          ssh-key: ${{ secrets.NHS_HOMETEST_SERVICE_DEPLOY_KEY_SSH_PRIV }}

      - name: "Set modules to deploy"
        id: set-modules
        run: |
          WORKING_DIR_BASE="hometest-mgmt-terraform/infrastructure/environments/${{ inputs.environment }}/${{ inputs.stack }}"
          echo "working_dir_base=${WORKING_DIR_BASE}" >> "$GITHUB_OUTPUT"

          if [ "${{ inputs.module }}" == "all" ]; then
            # Deploy in dependency order
            echo 'modules=["bootstrap", "network", "aurora-postgres", "shared_services", "hometest-app"]' >> "$GITHUB_OUTPUT"
          else
            echo 'modules=["${{ inputs.module }}"]' >> "$GITHUB_OUTPUT"
          fi

      - name: "Validate module path exists"
        run: |
          BASE_PATH="hometest-mgmt-terraform/infrastructure/environments/${{ inputs.environment }}/${{ inputs.stack }}"
          if [ "${{ inputs.module }}" != "all" ]; then
            if [ ! -d "${BASE_PATH}/${{ inputs.module }}" ]; then
              echo "::error::Module path '${BASE_PATH}/${{ inputs.module }}' does not exist"
              exit 1
            fi
          fi

      - name: "Display deployment info"
        run: |
          {
            echo "## Deployment Configuration"
            echo "| Parameter | Value |"
            echo "|-----------|---------|"
            echo "| Environment | ${{ inputs.environment }} |"
            echo "| Stack | ${{ inputs.stack }} |"
            echo "| Module(s) | ${{ inputs.module }} |"
            echo "| Action | ${{ inputs.action }} |"
            echo "| Triggered by | ${{ github.actor }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    name: "Deploy ${{ matrix.module }}"
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: true
      max-parallel: 1  # Sequential deployment to respect dependencies
      matrix:
        module: ${{ fromJson(needs.validate-inputs.outputs.modules) }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          path: hometest-mgmt-terraform

      - name: "Checkout hometest-service"
        uses: actions/checkout@v6
        with:
          path: hometest-service
          repository: "NHSDigital/hometest-service"
          ref: ${{ inputs.hometest_service_ref }}
          ssh-key: ${{ secrets.NHS_HOMETEST_SERVICE_DEPLOY_KEY_SSH_PRIV }}

      - name: "Deploy ${{ matrix.module }}"
        uses: ./hometest-mgmt-terraform/.github/actions/deploy-terragrunt
        with:
          aws_role_arn: ${{ secrets.AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          working_directory: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.module }}
          action: ${{ inputs.action }}

      - name: "Post deployment summary"
        if: always()
        run: |
          {
            echo "## Module: ${{ matrix.module }}"
            echo "- **Status**: ${{ job.status }}"
            echo "- **Action**: ${{ inputs.action }}"
            echo "- **Path**: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.module }}"
          } >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always()
    steps:
      - name: "Generate summary"
        run: |
          {
            echo "## Deployment Complete"
            echo ""
            echo "| Detail | Value |"
            echo "|--------|-------|"
            echo "| Environment | ${{ inputs.environment }} |"
            echo "| Stack | ${{ inputs.stack }} |"
            echo "| Module(s) | ${{ inputs.module }} |"
            echo "| Action | ${{ inputs.action }} |"
            echo "| Overall Status | ${{ needs.deploy.result }} |"
            echo "| Run ID | ${{ github.run_id }} |"
            echo "| Triggered by | ${{ github.actor }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  slack-notification:
    name: "Slack Notification"
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always()
    steps:
      - name: "Check if Slack webhook exists"
        id: check
        run: echo "secret_exists=${{ secrets.SLACK_WEBHOOK_URL != '' }}" >> "$GITHUB_OUTPUT"

      - name: "Determine deployment status"
        id: status
        run: |
          if [[ "${{ needs.deploy.result }}" == "failure" ]]; then
            {
              echo "status=failure"
              echo "color=#dc3545"
              echo "emoji=:x:"
            } >> "$GITHUB_OUTPUT"
          elif [[ "${{ needs.deploy.result }}" == "cancelled" ]]; then
            {
              echo "status=cancelled"
              echo "color=#ffc107"
              echo "emoji=:warning:"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "status=success"
              echo "color=#28a745"
              echo "emoji=:white_check_mark:"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: "Send Slack notification"
        if: steps.check.outputs.secret_exists == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ steps.status.outputs.emoji }} Terraform ${{ inputs.action }} ${{ steps.status.outputs.status }}"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\n${{ inputs.environment }}" },
                        { "type": "mrkdwn", "text": "*Stack:*\n${{ inputs.stack }}" },
                        { "type": "mrkdwn", "text": "*Module:*\n${{ inputs.module }}" },
                        { "type": "mrkdwn", "text": "*Action:*\n${{ inputs.action }}" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" },
                        { "type": "mrkdwn", "text": "*Status:*\n${{ needs.deploy.result }}" }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": { "type": "plain_text", "text": "View Run" },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
