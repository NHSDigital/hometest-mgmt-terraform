---
name: "Deploy Terraform Module"
run-name: "Deploy env: ${{ inputs.environment }}, module: ${{ inputs.module }}, tf: ${{ inputs.action }}"

# ${{ inputs.tag }} - the tag being deployed
# ${{ inputs.environment }} - target environment
# ${{ github.ref_name }} - branch name
# ${{ github.actor }} - who triggered the workflow
# If you'd prefer to show the commit message instead of/in addition to branch name, you can use ${{ github.event.head_commit.message }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - poc
        default: poc
      stack:
        description: "Infrastructure stack"
        required: true
        type: choice
        options:
          - core
          - dev
        default: core
      module:
        description: "Terraform module to deploy"
        required: true
        type: choice
        options:
          - bootstrap
          - network
          - rds-postgres
          - all
        default: bootstrap
      action:
        description: "Terraform action to perform"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy-plan
          - destroy
        default: plan

env:
  AWS_REGION: "eu-west-2"
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  validate-inputs:
    name: "Validate inputs"
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      modules: ${{ steps.set-modules.outputs.modules }}
      working_dir_base: ${{ steps.set-modules.outputs.working_dir_base }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6

      - name: "Set modules to deploy"
        id: set-modules
        run: |
          WORKING_DIR_BASE="infrastructure/environments/${{ inputs.environment }}/${{ inputs.stack }}"
          echo "working_dir_base=${WORKING_DIR_BASE}" >> $GITHUB_OUTPUT

          if [ "${{ inputs.module }}" == "all" ]; then
            # Deploy in dependency order
            echo 'modules=["bootstrap", "network", "rds-postgres"]' >> $GITHUB_OUTPUT
          else
            echo 'modules=["${{ inputs.module }}"]' >> $GITHUB_OUTPUT
          fi

      - name: "Validate module path exists"
        run: |
          BASE_PATH="infrastructure/environments/${{ inputs.environment }}/${{ inputs.stack }}"
          if [ "${{ inputs.module }}" != "all" ]; then
            if [ ! -d "${BASE_PATH}/${{ inputs.module }}" ]; then
              echo "::error::Module path '${BASE_PATH}/${{ inputs.module }}' does not exist"
              exit 1
            fi
          fi

      - name: "Display deployment info"
        run: |
          echo "## Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | ${{ inputs.stack }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Module(s) | ${{ inputs.module }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ inputs.action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${{ inputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: "Deploy ${{ matrix.module }}"
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: true
      max-parallel: 1  # Sequential deployment to respect dependencies
      matrix:
        module: ${{ fromJson(needs.validate-inputs.outputs.modules) }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6

      - name: "Deploy ${{ matrix.module }}"
        uses: ./.github/actions/deploy-terragrunt
        with:
          aws_role_arn: ${{ secrets.AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          working_directory: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.module }}
          action: ${{ inputs.action }}

      - name: "Post deployment summary"
        if: always()
        run: |
          echo "## Module: ${{ matrix.module }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.module }}" >> $GITHUB_STEP_SUMMARY

  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always()
    steps:
      - name: "Generate summary"
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | ${{ inputs.stack }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Module(s) | ${{ inputs.module }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ inputs.action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Status | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
