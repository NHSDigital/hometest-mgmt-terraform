---
name: "Deploy Terraform HomeTest App"
run-name: "Deploy env: ${{ inputs.environment || 'poc' }}, subenv: ${{ inputs.subenv || 'dev' }}, tf: ${{ inputs.action || 'plan' }}"

on:
  workflow_dispatch:
    inputs:
      hometest_service_ref:
        description: "Branch, tag, or SHA to checkout for hometest-service"
        required: false
        default: "main"
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - poc
        default: poc
      subenv:
        description: "Terraform subenv to deploy"
        required: true
        type: choice
        default: dev
        options:
          - dev
          # - dev-example
          - uat
      action:
        description: "Terraform action to perform"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
          # - destroy-plan
        default: plan

env:
  AWS_REGION: "eu-west-2"
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  validate-inputs:
    name: "Validate inputs"
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      subenvs: ${{ steps.set-subenvs.outputs.subenvs }}
      working_dir_base: ${{ steps.set-subenvs.outputs.working_dir_base }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          path: hometest-mgmt-terraform

      - name: "Checkout hometest-service"
        uses: actions/checkout@v6
        with:
          repository: "NHSDigital/hometest-service"
          ref: ${{ inputs.hometest_service_ref || 'main' }}
          path: hometest-service
          ssh-key: ${{ secrets.NHS_HOMETEST_SERVICE_DEPLOY_KEY_SSH_PRIV }}

      - name: "Set subenvs to deploy"
        id: set-subenvs
        run: |
          WORKING_DIR_BASE="hometest-mgmt-terraform/infrastructure/environments/${{ inputs.environment || 'poc' }}/hometest-app"
          echo "working_dir_base=${WORKING_DIR_BASE}" >> "$GITHUB_OUTPUT"
          echo "subenvs=[\"${{ inputs.subenv || 'dev' }}\"]" >> "$GITHUB_OUTPUT"

      - name: "Validate subenv path exists"
        run: |
          BASE_PATH="hometest-mgmt-terraform/infrastructure/environments/${{ inputs.environment || 'poc' }}/hometest-app"
          if [ "${{ inputs.subenv || 'dev' }}" != "all" ]; then
            if [ ! -d "${BASE_PATH}/${{ inputs.subenv || 'dev' }}" ]; then
              echo "::error::subenv path '${BASE_PATH}/${{ inputs.subenv || 'dev' }}' does not exist"
              exit 1
            fi
          fi

      - name: "Display deployment info"
        run: |
          HS_COMMIT=$(git -C hometest-service rev-parse HEAD)
          HS_COMMIT_SHORT=$(git -C hometest-service rev-parse --short HEAD)
          {
            echo "## Deployment Configuration"
            echo "| Parameter | Value |"
            echo "|-----------|---------|"
            echo "| Environment | ${{ inputs.environment || 'poc' }} |"
            echo "| Stack | hometest-app |"
            echo "| Subenv(s) | ${{ inputs.subenv || 'dev' }} |"
            echo "| Action | ${{ inputs.action || 'plan' }} |"
            echo "| Triggered by | ${{ github.actor }} |"
            echo "| hometest-service ref | \`${{ inputs.hometest_service_ref || 'main' }}\` |"
            echo "| hometest-service commit | \`${HS_COMMIT_SHORT}\` (${HS_COMMIT}) |"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    name: "Deploy ${{ matrix.subenv }}"
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: true
      max-parallel: 1  # Sequential deployment to respect dependencies
      matrix:
        subenv: ${{ fromJson(needs.validate-inputs.outputs.subenvs) }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          path: hometest-mgmt-terraform

      - name: "Checkout hometest-service"
        uses: actions/checkout@v6
        with:
          repository: "NHSDigital/hometest-service"
          ref: ${{ inputs.hometest_service_ref || 'main' }}
          path: hometest-service
          ssh-key: ${{ secrets.NHS_HOMETEST_SERVICE_DEPLOY_KEY_SSH_PRIV }}

      - name: "Cache node_modules"
        uses: actions/cache@v5
        with:
          path: |
            hometest-service/node_modules
            hometest-service/ui/node_modules
            hometest-service/lambdas/node_modules
            hometest-service/tests/node_modules
          key: node-modules-${{ runner.os }}-mgmt-${{ github.event_name == 'pull_request' && 'pr' || 'push' }}-${{ hashFiles('hometest-service/**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-mgmt-${{ github.event_name == 'pull_request' && 'pr' || 'push' }}-
            node-modules-${{ runner.os }}-mgmt-
            node-modules-${{ runner.os }}-

      - name: Install mise tools
        uses: ./hometest-mgmt-terraform/.github/actions/install-mise
        with:
          working_directory: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.subenv }}

      - name: "Deploy ${{ matrix.subenv }}"
        uses: ./hometest-mgmt-terraform/.github/actions/deploy-terragrunt
        with:
          aws_role_arn: ${{ secrets.AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          working_directory: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.subenv }}
          action: ${{ inputs.action || 'plan' }}

      - name: "Post deployment summary"
        if: always()
        run: |
          {
            echo "## Subenv: ${{ matrix.subenv }}"
            echo "- **Status**: ${{ job.status }}"
            echo "- **Action**: ${{ inputs.action || 'plan' }}"
            echo "- **Path**: ${{ needs.validate-inputs.outputs.working_dir_base }}/${{ matrix.subenv }}"
          } >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always()
    steps:
      - name: "Generate summary"
        run: |
          {
            echo "## Deployment Complete"
            echo ""
            echo "| Detail | Value |"
            echo "|--------|-------|"
            echo "| Environment | ${{ inputs.environment || 'poc' }} |"
            echo "| Stack | hometest-app |"
            echo "| Subenv(s) | ${{ inputs.subenv || 'dev' }} |"
            echo "| Action | ${{ inputs.action || 'plan' }} |"
            echo "| Overall Status | ${{ needs.deploy.result }} |"
            echo "| Run ID | ${{ github.run_id }} |"
            echo "| Triggered by | ${{ github.actor }} |"
          } >> "$GITHUB_STEP_SUMMARY"
